<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="kubernetes,">





  <link rel="alternate" href="/atom.xml" title="weshzhu blogs" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2">






<meta name="description" content="NGINX Ingress Controller[TOC] Bare-metal considerations MetalLBMetalLB提供了一个不仅仅只有云服务商才可提供的在kubernetes集群上的网络负载均衡实现。有效地允许在任何集群中使用 LoadBalancer 服务。本教程介绍使用 Layer 2 configuration mode MetalLB和NGINX Ingress">
<meta name="keywords" content="kubernetes">
<meta property="og:type" content="article">
<meta property="og:title" content="NGINX Ingress Controller教程">
<meta property="og:url" content="http://weshzhu.com/nginx-ingress-controller-introduct/index.html">
<meta property="og:site_name" content="weshzhu blogs">
<meta property="og:description" content="NGINX Ingress Controller[TOC] Bare-metal considerations MetalLBMetalLB提供了一个不仅仅只有云服务商才可提供的在kubernetes集群上的网络负载均衡实现。有效地允许在任何集群中使用 LoadBalancer 服务。本教程介绍使用 Layer 2 configuration mode MetalLB和NGINX Ingress">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://weshzhu.com/images/metallb.jpg">
<meta property="og:image" content="http://weshzhu.com/images/nodeport.jpg">
<meta property="og:image" content="http://weshzhu.com/images/hostnetwork.jpg">
<meta property="og:image" content="http://weshzhu.com/images/user_edge.jpg">
<meta property="og:updated_time" content="2019-04-02T02:15:14.576Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="NGINX Ingress Controller教程">
<meta name="twitter:description" content="NGINX Ingress Controller[TOC] Bare-metal considerations MetalLBMetalLB提供了一个不仅仅只有云服务商才可提供的在kubernetes集群上的网络负载均衡实现。有效地允许在任何集群中使用 LoadBalancer 服务。本教程介绍使用 Layer 2 configuration mode MetalLB和NGINX Ingress">
<meta name="twitter:image" content="http://weshzhu.com/images/metallb.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://weshzhu.com/nginx-ingress-controller-introduct/">





  <title>NGINX Ingress Controller教程 | weshzhu blogs</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">weshzhu blogs</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">微什猪</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            站点地图
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://weshzhu.com/nginx-ingress-controller-introduct/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="weshzhu">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="weshzhu blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">NGINX Ingress Controller教程</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-25T16:26:10+00:00">
                2019-01-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/运维/" itemprop="url" rel="index">
                    <span itemprop="name">运维</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/运维/kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/nginx-ingress-controller-introduct/" class="leancloud_visitors" data-flag-title="NGINX Ingress Controller教程">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  2,453字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  12分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="NGINX-Ingress-Controller"><a href="#NGINX-Ingress-Controller" class="headerlink" title="NGINX Ingress Controller"></a>NGINX Ingress Controller</h2><p>[TOC]</p>
<h3 id="Bare-metal-considerations"><a href="#Bare-metal-considerations" class="headerlink" title="Bare-metal considerations"></a>Bare-metal considerations</h3><ul>
<li>MetalLB<br><code>MetalLB</code>提供了一个不仅仅只有云服务商才可提供的在<code>kubernetes</code>集群上的网络负载均衡实现。有效地允许在任何集群中使用 LoadBalancer 服务。<br>本教程介绍使用<a href="https://metallb.universe.tf/tutorial/layer2/" target="_blank" rel="noopener"> <strong>Layer 2 configuration mode</strong></a> <a href="https://metallb.universe.tf/" target="_blank" rel="noopener"><strong>MetalLB</strong></a>和<code>NGINX Ingress controller</code>在集群中有公开访问的节点。在此模式下，一个节点吸引<code>ingress-nginx</code>服务IP的所有流量。<br><strong>MetalLB:Layer2</strong><br><img src="/images/metallb.jpg" alt="MetalLB:Layer2"><br>例如：Given the following 3-node Kubernetes cluster (the external IP is added as an example, in most bare-metal environments this value is <none>)<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe node</span><br><span class="line">NAME     STATUS   ROLES    EXTERNAL-IP</span><br><span class="line">host-1   Ready    master   203.0.113.1</span><br><span class="line">host-2   Ready    node     203.0.113.2</span><br><span class="line">host-3   Ready    node     203.0.113.3</span><br></pre></td></tr></table></figure>
</none></li>
</ul>
<p>依照下方<code>yaml</code>文件创建<code>ComfigMap</code>, MetalLB获得池中其中一个IP地址的所有权，并相应地更新<code>ingress-nginx</code>服务的<code>loadBalancer IP</code>字段。.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  namespace: metallb-system</span><br><span class="line">  name: config</span><br><span class="line">data:</span><br><span class="line">  config: |</span><br><span class="line">    address-pools:</span><br><span class="line">    - name: default</span><br><span class="line">      protocol: layer2</span><br><span class="line">      addresses:</span><br><span class="line">      - 203.0.113.2-203.0.113.3</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -n ingress-nginx get svc</span><br><span class="line">NAME                   TYPE          CLUSTER-IP     EXTERNAL-IP  PORT(S)</span><br><span class="line">default-http-backend   ClusterIP     10.0.64.249    &lt;none&gt;       80/TCP</span><br><span class="line">ingress-nginx          LoadBalancer  10.0.220.217   203.0.113.3  80:30100/TCP,443:30101/TCP</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><h5 id="Over-a-NodePort-Service"><a href="#Over-a-NodePort-Service" class="headerlink" title="Over a NodePort Service"></a>Over a NodePort Service</h5><p>在该配置下，NGINX 容器与主机网络保持隔离。因此，它可以安全地绑定到任何端口，包括标准HTTP端口80和443.但是，由于容器命名空间隔离，位于群集网络外部的客户端（例如，在公共Internet上）无法直接通过端口80和443访问Ingress。因此，必须分配<code>ingress-nginx service</code>的<code>Type</code>为<code>Nodeport</code>。<br><img src="/images/nodeport.jpg" alt="Over a NodePort Service"><br>例如：Given the NodePort 30100 allocated to the ingress-nginx Service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc -n ingress-nginx</span><br><span class="line">NAME                   TYPE        CLUSTER-IP     PORT(S)</span><br><span class="line">default-http-backend   ClusterIP   10.0.64.249    80/TCP</span><br><span class="line">ingress-nginx          NodePort    10.0.220.217   80:30100/TCP,443:30101/TCP</span><br></pre></td></tr></table></figure>
<p>其中一个<code>Node</code>节点的IP地址为203.0.113.2 (<code>external IP</code>只是一个举例, 在大部分 bare-metal环境中该值是<code>&lt;None&gt;</code>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe node</span><br><span class="line">NAME     STATUS   ROLES    EXTERNAL-IP</span><br><span class="line">host-1   Ready    master   203.0.113.1</span><br><span class="line">host-2   Ready    node     203.0.113.2</span><br><span class="line">host-3   Ready    node     203.0.113.3</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>客户端可通过<code>http://myapp.example.com:30100</code>与配置<code>host</code>:<code>myapp.example.com</code>的<code>Ingress</code>进行通信，<code>myapp.example.com</code> 子域解析为203.0.113.2地址。<br>这种方法还有一些应该注意的其他限制</p>
<ul>
<li><p><strong>Source IP address</strong><br>Services of type NodePort perform source address translation by default。这意味着：HTTP请求的<code>source IP</code>始终是从NGINX的角度接收请求的Kubernetes节点的IP地址。<br>建议通过设置<code>ingress-nginx Service</code>的<code>spec.externalTrafficPolicy</code>的属性域为<code>local</code>（<a href="https://github.com/kubernetes/ingress-nginx/blob/nginx-0.19.0/deploy/provider/aws/service-nlb.yaml#L12-L14" target="_blank" rel="noopener">例如</a>），来保留<code>source IP</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># this setting is t make sure the source IP address is preserved.</span></span><br><span class="line"><span class="attr">  externalTrafficPolicy:</span> <span class="string">Local</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">http</span></span><br><span class="line">	<span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">	<span class="attr">targetPort:</span> <span class="string">http</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>例如一个集群中有三个<code>Node</code>，(<code>external IP</code>只是一个举例, 在大部分 bare-metal环境中该值是<code>&lt;None&gt;</code>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe node</span><br><span class="line">NAME     STATUS   ROLES    EXTERNAL-IP</span><br><span class="line">host-1   Ready    master   203.0.113.1</span><br><span class="line">host-2   Ready    node     203.0.113.2</span><br><span class="line">host-3   Ready    node     203.0.113.3</span><br></pre></td></tr></table></figure>
<p>nginx-ingress-controller的Deployment 有两个副本集<code>replicas</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -o wide -n ingress-nginx</span><br><span class="line">NAME                                       READY   STATUS    IP           NODE</span><br><span class="line">default-http-backend-7c5bc89cc9-p86md      1/1     Running   172.17.1.1   host-2</span><br><span class="line">nginx-ingress-controller-cf9ff8c96-8vvf8   1/1     Running   172.17.0.3   host-3</span><br><span class="line">nginx-ingress-controller-cf9ff8c96-pxsds   1/1     Running   172.17.1.4   host-2</span><br></pre></td></tr></table></figure>
<p>到<code>host-2</code>和<code>host-3</code>的请求将被转发到 <code>NGINX</code>并且原始的客户端IP将被保留，但是请求到<code>host-1</code>的<code>Node</code>的请求将被丢弃，因为在该<code>Node</code>上没有<code>NGINX</code>副本集。</p>
</li>
<li><p><strong>Ingress status</strong><br>因为<code>NodePort</code>类型的<code>Service</code>没有按定义分配<code>LoadBalancerIP</code>，<code>NGINX Ingress controller</code>不会更新<code>Ingress</code>对象的状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get ingress</span><br><span class="line">   NAME           HOSTS               ADDRESS   PORTS</span><br><span class="line">   test-ingress   myapp.example.com             80</span><br></pre></td></tr></table></figure>
<p>尽管没有负载均衡器为<code>NGINX Ingress Controller</code>提供公共IP地址，但可以通过设置<code>ingress-nginx Service</code>的<code>externalIPs</code>字段来强制所有管理的Ingress对象的状态更新。<br>例如：一个集群中有三个<code>Node</code>，(<code>external IP</code>只是一个举例, 在大部分 bare-metal环境中该值是<code>&lt;None&gt;</code>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe node</span><br><span class="line">NAME     STATUS   ROLES    EXTERNAL-IP</span><br><span class="line">host-1   Ready    master   203.0.113.1</span><br><span class="line">host-2   Ready    node     203.0.113.2</span><br><span class="line">host-3   Ready    node     203.0.113.3</span><br></pre></td></tr></table></figure>
<p>可以编辑<code>ingress-nginx Service</code> 添加如下代码片段到到属性域<code>spec</code>中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">  externalIPs:</span><br><span class="line">  - 203.0.113.1</span><br><span class="line">  - 203.0.113.2</span><br><span class="line">  - 203.0.113.3</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>如此，将会在<code>Ingress</code>对象上生效：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get ingress -o wide</span><br><span class="line">NAME           HOSTS               ADDRESS                               PORTS</span><br><span class="line">test-ingress   myapp.example.com   203.0.113.1,203.0.113.2,203.0.113.3   80</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Redirects</strong></p>
<blockquote>
<p>As NGINX is not aware of the port translation operated by the NodePort Service, backend applications are responsible for generating redirect URLs that take into account the URL used by external clients, including the NodePort.</p>
</blockquote>
<p>由于NGINX不知道NodePort服务运营的端口转换，后端应用程序负责生成考虑外部客户端（包括NodePort）使用的URL的重定向URL。<br>举例：Redirects generated by NGINX, for instance HTTP to HTTPS or domain to <a href="http://www.domain" target="_blank" rel="noopener">www.domain</a>, are generated without NodePort:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl -D- http://myapp.example.com:30100</span><br><span class="line">HTTP/1.1 308 Permanent Redirect</span><br><span class="line">Server: nginx/1.15.2</span><br><span class="line">Location: https://myapp.example.com/  #-&gt; missing NodePort in HTTPS redirect</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<ul>
<li><h5 id="Via-the-host-network"><a href="#Via-the-host-network" class="headerlink" title="Via the host network"></a>Via the host network</h5><p>在没有可用的外部负载均衡器的设置中，但不能使用<code>NodePorts</code>。还有一种方法就是，通过设置<code>ingress-nginx</code>的Pods使用<strong>主机网络</strong>，而不是专用的网络命名空间(<code>network namespace</code>)。该方案的好处就是，在没有额外的<code>NodePort Service</code>提供的外部网络转换情况下，<code>NGINX Ingress controller</code>可以直接绑定k8s的<code>Node</code>网络接口的端口80或443。<br>这可以通过配置Pods属性域<code>template.spec</code>的<code>hostNetwork</code>选项来实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> template:</span><br><span class="line"> spec:</span><br><span class="line">hostNetwork: true</span><br></pre></td></tr></table></figure>
<p>注意：<br>启用此选项会将所有系统守护进程暴露给任何网络接口上的<code>NGINX Ingress Controller</code>，包括主机的环回地址。请仔细评估这可能对您系统的安全性产生的影响。<br>例如：<code>nginx-ingress-controller</code>Deployment有两个副本集，<code>NGINX</code> PodsN继承其主机的IP地址，而不是内部 Pod IP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  $ kubectl get pod -o wide -n ingress-nginx</span><br><span class="line">NAME                                       READY   STATUS    IP            NODE</span><br><span class="line">default-http-backend-7c5bc89cc9-p86md      1/1     Running   172.17.1.1    host-2</span><br><span class="line">nginx-ingress-controller-5b4cf5fc6-7lg6c   1/1     Running   203.0.113.3   host-3</span><br><span class="line">nginx-ingress-controller-5b4cf5fc6-lzrls   1/1     Running   203.0.113.2   host-2</span><br></pre></td></tr></table></figure>
<p>该部署方式的主要限制是：每个群集节点上只能安排一个<code>NGINX Ingress Controller</code> Pod，这是因为在同一网络接口上多次绑定同一个端口在技术上是不可能的。举例：因此方式导致的 Pods 不可调度，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  $ kubectl -n ingress-nginx describe pod &lt;unschedulable-nginx-ingress-controller-pod&gt;</span><br><span class="line">...</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            From               Message</span><br><span class="line">  ----     ------            ----               -------</span><br><span class="line">  Warning  FailedScheduling  default-scheduler  0/3 nodes are available: 3 node(s) didn&apos;t have free ports for the requested pod ports.</span><br></pre></td></tr></table></figure>
<p>确保仅创建可调度Pod的一种方法是将<code>NGINX Ingress Controller</code>部署为<code>DaemonSet</code>而不是传统的<code>Deployment</code>。<br><img src="/images/hostnetwork.jpg" alt="hostnetwork"><br>与NodePorts一样，这种方法有一些怪癖，重要的是要注意</p>
<ul>
<li><p><strong>DNS resolution</strong><br>如果Pods配置了<code>hostNetwork: true</code>属性，则不使用内部DNS解析器(<code>kube-dns</code>或<code>CoreDns</code>)，除非Pods的<code>spec.dnsPolicy</code>配置了<code>ClusterFirstWithHostNet</code>属性。</p>
</li>
<li><p><strong>Ingress status</strong><br>由于在使用主机网络的配置中没有服务公开NGINX Ingress控制器，因此标准云设置中使用的默认–publish-service标志不适用，并且所有Ingress对象的状态保持空白。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> $ kubectl get ingress</span><br><span class="line">NAME           HOSTS               ADDRESS   PORTS</span><br><span class="line">test-ingress   myapp.example.com             80</span><br></pre></td></tr></table></figure>
<p>相反，由于<code>bare-metal</code>Node通常没有<code>Extral IP</code>，因此必须启用<code>--report-node-internal-ip-address</code>，它将所有Ingress对象的状态设置为运行<code>NGINX Ingress Controller</code>的所有节点的内部IP地址。<br>Given a nginx-ingress-controller DaemonSet composed of 2 replicas</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> $ kubectl -n ingress-nginx get pod -o wide</span><br><span class="line">NAME                                       READY   STATUS    IP            NODE</span><br><span class="line">default-http-backend-7c5bc89cc9-p86md      1/1     Running   172.17.1.1    host-2</span><br><span class="line">nginx-ingress-controller-5b4cf5fc6-7lg6c   1/1     Running   203.0.113.3   host-3</span><br><span class="line">nginx-ingress-controller-5b4cf5fc6-lzrls   1/1     Running   203.0.113.2   host-2</span><br></pre></td></tr></table></figure>
<p>控制器将其管理的所有Ingress对象的状态设置为以下值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> $ kubectl get ingress -o wide</span><br><span class="line">NAME           HOSTS               ADDRESS                   PORTS</span><br><span class="line">test-ingress   myapp.example.com   203.0.113.2,203.0.113.3   80</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><h5 id="Using-a-self-provisioned-edge"><a href="#Using-a-self-provisioned-edge" class="headerlink" title="Using a self-provisioned edge"></a>Using a self-provisioned edge</h5><p>与云环境类似，该部署方式需要边缘网络组件（edge network component ）为Kubernetes集群提供公共入口点。该边缘组件可以是硬件（例如供应商设备）或软件（例如HAproxy），并且通常由运营团队在Kubernetes范围之外进行管理。<br>此类部署基于上面在Over NodePort服务中描述的NodePort服务构建，但有一个显着区别：外部客户端不直接访问集群节点，只有边缘组件才能访问集群节点。这特别适用于没有节点具有公共IP地址的私有Kubernetes集群。<br>边缘网络外部，唯一的先决条件是专用一个公共IP地址，将所有HTTP流量转发到Kubernetes节点和/或主节点。 TCP端口80和443上的传入流量将转发到目标节点上的相应HTTP和HTTPS NodePort，如下图所示：<br><img src="/images/user_edge.jpg" alt="Using a self-provisioned edge"><br>根据官方Kubernetes文档的“服务”页面，<code>externalIPs</code>选项使kube-proxy将发送到任意IP地址和服务端口的流量路由到该服务的<code>endpoints</code>。这些IP地址必须属于目标节点(target node)。</p>
<blockquote>
<p>例如：一个集群中有三个<code>Node</code>，(<code>external IP</code>只是一个举例, 在大部分 bare-metal环境中该值是<code>&lt;None&gt;</code>)</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe node</span><br><span class="line">NAME     STATUS   ROLES    EXTERNAL-IP</span><br><span class="line">host-1   Ready    master   203.0.113.1</span><br><span class="line">host-2   Ready    node     203.0.113.2</span><br><span class="line">host-3   Ready    node     203.0.113.3</span><br></pre></td></tr></table></figure>
</blockquote>
<p>and the following ingress-nginx NodePort Service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -n ingress-nginx get svc</span><br><span class="line">NAME                   TYPE        CLUSTER-IP     PORT(S)</span><br><span class="line">ingress-nginx          NodePort    10.0.220.217   80:30100/TCP,443:30101/TCP</span><br></pre></td></tr></table></figure>
<p>我们可以在<code>Service</code>的<code>spec.externalIPs</code>属性域中设置<strong>externalIPs</strong>, 则<strong>NGINX</strong>通过<code>NodePort</code>和<code>Service Port</code>变的可达：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">externalIPs:</span><br><span class="line">- 203.0.113.2</span><br><span class="line">- 203.0.113.3</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ curl -D- http://myapp.example.com:30100</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.15.2</span><br><span class="line">$ curl -D- http://myapp.example.com</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.15.2</span><br></pre></td></tr></table></figure>
<p>我们假设 <code>myapp.example.com</code> 域名解析成IP地址：203.0.113.2 和 203.0.113.3。</p>
</li>
</ul>

      
    </div>
    
    
    

    

    

    
      <div style="border-left: 0px solid #ff8d00; margin-bottom: 30px;">
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    weshzhu
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://weshzhu.com/nginx-ingress-controller-introduct/" title="NGINX Ingress Controller教程">http://weshzhu.com/nginx-ingress-controller-introduct/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    
    
      
        <div>
          <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-8744947453786229" data-ad-slot="1288395041"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

        </div>
      
    
    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/private-registry-docker/" rel="next" title="Centos搭建Docker私有仓库, Registry">
                <i class="fa fa-chevron-left"></i> Centos搭建Docker私有仓库, Registry
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/docker-storage/" rel="prev" title="docker存储原理——介绍">
                docker存储原理——介绍 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="weshzhu">
          <p class="site-author-name" itemprop="name">weshzhu</p>
           
              <p class="site-description motion-element" itemprop="description">持之以恒，一日不作，一日不食~~ </p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://me.csdn.net/zsd498537806" target="_blank" rel="external nofollow" title="csdn">
                  
                    <i class="fa fa-fw fa-cuttlefish"></i>
                  
                    
                      csdn
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://github.com" title="Github" target="_blank">Github</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://blog.csdn.net/zsd498537806" title="CSDN" target="_blank">CSDN</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.baidu.com" title="百度" target="_blank">百度</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.google.com" title="Google" target="_blank">Google</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#NGINX-Ingress-Controller"><span class="nav-number">1.</span> <span class="nav-text">NGINX Ingress Controller</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Bare-metal-considerations"><span class="nav-number">1.1.</span> <span class="nav-text">Bare-metal considerations</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Over-a-NodePort-Service"><span class="nav-number">1.1.0.1.</span> <span class="nav-text">Over a NodePort Service</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Via-the-host-network"><span class="nav-number">1.1.0.2.</span> <span class="nav-text">Via the host network</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Using-a-self-provisioned-edge"><span class="nav-number">1.1.0.3.</span> <span class="nav-text">Using a self-provisioned edge</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">weshzhu</span>
</div>


<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>

<div class="powered-by">
  由 <a rel="external nofollow" class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a rel="external nofollow" class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共28.5k字</span>
</div>

        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("nSSt5cKO2R1XjIwU9KlbUtOc-gzGzoHsz", "lc8U1dg1a1oYdIFq4YU26gmH");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
